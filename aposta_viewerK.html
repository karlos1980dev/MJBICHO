<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visualizar e Imprimir Aposta</title>

  <style>
    body {
      background: #1f1c2c;
      color: #f0f0f0;
      font-family: Arial, sans-serif;
      padding: 10px;
      text-align: center;
      margin:0;
    }
    .container {
      width: 100%;
      max-width: 480px;
      margin: auto;
      background-color: #2c2a3a;
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
    }
    h2 {
      color: #25d366;
      margin-bottom: 20px;
      font-weight: 700;
      letter-spacing: 1.5px;
    }
    .resultado {
      background-color: #1e1c2c;
      padding: 15px;
      border-radius: 10px;
      text-align: left;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      min-height: 120px;
      user-select: text;
      box-shadow: inset 0 0 8px #25d366aa;
    }
    button {
      margin-top: 15px;
      background-color: #25d366;
      color: white;
      border: none;
      padding: 12px 18px;
      font-weight: 700;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(37, 211, 102, 0.6);
      transition: background-color 0.3s ease;
      width: 100%;
    }
    button:hover {
      background-color: #1e9e58;
    }
    /* Modal simples */
    #modalErro, #modalResumo {
      display: none;
      position: fixed;
      top: 0; left: 0; right:0; bottom: 0;
      background: rgba(0,0,0,0.85);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    #modalErro > div, #modalResumo > div {
      background: #2c2a3a;
      padding: 25px 30px;
      border-radius: 12px;
      max-width: 400px;
      width: 100%;
      color: #eee;
      position: relative;
      box-shadow: 0 8px 25px rgba(0,0,0,0.8);
      text-align: left;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 14px;
    }
    #modalErro span, #modalResumo span {
      position: absolute;
      top: 12px;
      right: 16px;
      font-size: 24px;
      font-weight: 900;
      cursor: pointer;
      color: #ff4c4c;
      user-select: none;
      transition: color 0.2s ease;
    }
    #modalErro span:hover, #modalResumo span:hover {
      color: #ff0000;
    }
    #modalResumo h3 {
      color: #25d366;
      margin-bottom: 15px;
      font-weight: 700;
      text-align: center;
      white-space: normal;
      font-family: Arial, sans-serif;
    }

    /* √Årea de impress√£o - s√≥ fica vis√≠vel na impress√£o */
    #printable {
      display: none;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.3;
      color: black;
      background: white;
      padding: 10px;
      margin: 0 auto;
      max-width: 320px;
    }

    @media print {
      body * {
        visibility: hidden;
      }
      #printable, #printable * {
        visibility: visible;
      }
      #printable {
        position: absolute;
        top: 0; left: 0;
        width: 100%;
        margin: 0;
        padding: 10px;
        box-shadow: none;
        background: white;
        color: black;
      }
    }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDlWGPUuGyugzvvQt_Wd5GI3IBFH90hUgQ",
      authDomain: "multijogo.firebaseapp.com",
      databaseURL: "https://multijogo-default-rtdb.firebaseio.com",
      projectId: "multijogo",
      storageBucket: "multijogo.appspot.com",
      messagingSenderId: "328198585423",
      appId: "1:328198585423:web:ae370bf8e7716ec2f17e3a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    window.onload = () => {
      const params = new URLSearchParams(window.location.search);
      const codigo = params.get("codigo");
      if (codigo) {
        buscarApostaPorCodigo(codigo.trim());
      } else {
        mostrarErro("‚ùó C√≥digo da aposta n√£o informado na URL.");
      }
    };

    function mostrarErro(msg) {
      const modal = document.getElementById("modalErro");
      const p = document.getElementById("mensagemErro");
      p.textContent = msg;
      modal.style.display = "flex";
    }
    function fecharErro() {
      document.getElementById("modalErro").style.display = "none";
    }

    let ultimaAposta = null; // Guarda a aposta para imprimir e enviar whatsapp

    function buscarApostaPorCodigo(codigo) {
      const resultadoDiv = document.getElementById("resultado");
      resultadoDiv.textContent = "üîç Buscando aposta...";

      db.ref(`apostas/${codigo}`).once("value").then(snapshot => {
        const dados = snapshot.val();
        if (!dados) {
          resultadoDiv.textContent = `‚ùå Aposta n√£o encontrada para o c√≥digo: ${codigo}`;
          return;
        }
        ultimaAposta = dados;

        let texto = montarTextoCompletoAposta(codigo, dados);
        resultadoDiv.textContent = texto;

        // Atualiza √°rea de impress√£o tamb√©m
        document.getElementById("printable").textContent = texto;
      }).catch(err => {
        mostrarErro("‚ö†Ô∏è Erro ao buscar aposta: " + err.message);
      });
    }

    function montarTextoCompletoAposta(codigo, dados) {
      const linhas = [];
      linhas.push(`*** APOSTA MULTIJOGO ***`);
      linhas.push(`C√≥digo: ${codigo}`);
      if (dados.data) linhas.push(`Data: ${dados.data}`);
      if (dados.horario) linhas.push(`Hor√°rio: ${dados.horario}`);
      linhas.push("");
      if (dados.totalPagar != null) linhas.push(`Total a Pagar: R$ ${Number(dados.totalPagar).toFixed(2)}`);
      if (dados.totalReceber != null) linhas.push(`Poss√≠vel Retorno: R$ ${Number(dados.totalReceber).toFixed(2)}`);
      linhas.push("\n-- Detalhes das Apostas --\n");

      const tiposSeparados = { milhar: [], centena: [], dezena: [], grupo: [] };

      if (Array.isArray(dados.apostas)) {
        dados.apostas.forEach(item => {
          const tipo = item.tipo?.toLowerCase();
          if (tiposSeparados[tipo]) tiposSeparados[tipo].push(item);
        });
      }

      function montarLinhasTipo(titulo, arr) {
        if (!arr || arr.length === 0) return [];
        const res = [`${titulo}:`];
        arr.forEach(item => {
          const numero = item.numero ?? item.numeros ?? "N/A";
          const valor = item.valor != null ? `R$ ${Number(item.valor).toFixed(2)}` : "";
          const pos = item.posicao ? `(1¬∫ ao ${item.posicao}¬∫)` : "";
          res.push(`  ${numero} - ${valor} ${pos}`);
        });
        return res;
      }

      linhas.push(...montarLinhasTipo("Milhar 5000", tiposSeparados.milhar));
      linhas.push("");
      linhas.push(...montarLinhasTipo("Centena 600", tiposSeparados.centena));
      linhas.push("");
      linhas.push(...montarLinhasTipo("Dezena 70", tiposSeparados.dezena));
      linhas.push("");
      linhas.push(...montarLinhasTipo("Grupo 16", tiposSeparados.grupo));
      linhas.push("");

      if (Array.isArray(dados.duques) && dados.duques.length > 0) {
        linhas.push("Duque de Dezenas 300:");
        dados.duques.forEach(d => {
          linhas.push(`  ${typeof d === 'string' ? d : JSON.stringify(d)}`);
        });
        linhas.push("");
      }

      linhas.push("Obrigado por apostar conosco!");
      return linhas.join("\n");
    }

    function imprimirAposta() {
      if (!ultimaAposta) {
        mostrarErro("Nenhuma aposta carregada para imprimir.");
        return;
      }
      window.print();
    }

    function enviarWhatsApp() {
      if (!ultimaAposta) {
        mostrarErro("Nenhuma aposta carregada para enviar.");
        return;
      }
      const codigo = ultimaAposta.codigo || new Date().getTime();
      const texto = document.getElementById("resultado").textContent;

      // Codifica para URL
      const textoEncoded = encodeURIComponent(texto);
      const telefone = "5571992290058"; // Altere para seu n√∫mero
      const url = `https://wa.me/${telefone}?text=${textoEncoded}`;

      window.open(url, "_blank");
    }
  </script>
</head>
<body>

  <div class="container">
    <h2>Detalhes da Aposta</h2>
    <pre id="resultado" class="resultado">Aguardando c√≥digo na URL...</pre>

    <button onclick="imprimirAposta()">üñ®Ô∏è Imprimir Aposta</button>
    <button style="margin-top:8px; background:#128C7E;" onclick="enviarWhatsApp()">üì≤ Enviar WhatsApp</button>
  </div>

  <!-- √Årea para impress√£o (invis√≠vel na tela) -->
  <pre id="printable"></pre>

  <!-- Modal Erro -->
  <div id="modalErro" style="display:none; align-items:center;">
    <div>
      <span onclick="fecharErro()">‚úñ</span>
      <h3>Erro</h3>
      <p id="mensagemErro"></p>
      <button onclick="fecharErro()">OK</button>
    </div>
  </div>

</body>
</html>
